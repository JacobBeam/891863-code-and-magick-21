(()=>{"use strict";(()=>{let e=function(e,t,n,o,l){let r=new XMLHttpRequest;switch(r.responseType="json",r.addEventListener("load",(function(){200===r.status?n(r.response):o("Произошла ошибка. Статус ответа: "+r.status)})),r.addEventListener("error",(function(){o("Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){o("Запрос не успел выполниться за 10000 мс")})),r.open(e,t),e){case"GET":r.send();break;case"POST":r.send(l);break;default:r.send()}};window.backend={load(t,n){e("GET","https://21.javascript.pages.academy/code-and-magick/data",t,n)},save(t,n,o){e("POST","https://21.javascript.pages.academy/code-and-magick",n,o,t)}}})(),window.util={debounce(e){let t=null;t&&window.clearTimeout(t),t=window.setTimeout(e,500)},isEscEvent(e,t,n){"Escape"===e.key&&n!==document.activeElement&&t()},isEnterEvent(e,t){"Enter"===e.key&&t()},getRandomNumber(e,t){let n=e+Math.random()*(t+1-e);return Math.floor(n)},shuffleArray(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},getRandomElement:e=>e[Math.floor(Math.random()*e.length)],createErrorMessage(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="fixed",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e=document.querySelector(".setup"),t=["rgb(101, 137, 164)","rgb(241, 43, 107)","rgb(146, 100, 161)","rgb(56, 159, 117)","rgb(215, 210, 55)","rgb(0, 0, 0)"],n=["black","red","blue","yellow","green"],o=["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"];let l={onEyesChange:function(){},onCoatChange:function(){}};const r=e.querySelector(".wizard-coat"),i=e.querySelector('input[name="coat-color"]');r.addEventListener("click",(function(e){let n=window.util.getRandomElement(t);e.target.style.fill=n,i.value=n,l.onCoatChange(n)}));const a=e.querySelector(".wizard-eyes"),c=e.querySelector('input[name="eyes-color"]');a.addEventListener("click",(function(e){let t=window.util.getRandomElement(n);e.target.style.fill=t,c.value=t,l.onEyesChange(t)}));const s=e.querySelector(".setup-fireball-wrap"),d=e.querySelector('input[name="fireball-color"]');s.addEventListener("click",(function(e){let t=window.util.getRandomElement(o);e.target.style.backgroundColor=t,d.value=t})),window.wizard={setCoatChangeHandler(e){l.onCoatChange=e},setEyesChangeHandler(e){l.onEyesChange=e}}})(),(()=>{let e="rgb(101, 137, 164)",t="black",n=[];const o=function(n){let o=0;return n.colorCoat===e&&(o+=2),n.colorEyes===t&&(o+=1),o},l=function(){window.render(n.sort((function(e,t){let n=o(t)-o(e);return 0===n&&(n=function(e,t){return e>t?1:e<t?-1:0}(e.name,t.name)),n})))};let r=function(e){window.util.createErrorMessage(e)};window.backend.load((function(e){n=e,l()}),r);const i=document.querySelector(".setup"),a=i.querySelector(".setup-wizard-form");let c=function(){i.classList.add("hidden")};a.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(new FormData(a),c,r)})),window.wizard.setEyesChangeHandler((function(e){t=e,window.util.debounce(l)})),window.wizard.setCoatChangeHandler((function(t){e=t,window.util.debounce(l)}))})(),(()=>{const e=document.querySelector(".setup"),t=document.querySelector("#similar-wizard-template").content.querySelector(".setup-similar-item");let n=function(e){let n=t.cloneNode(!0);return n.querySelector(".setup-similar-label").textContent=e.name,n.querySelector(".wizard-coat").style.fill=e.colorCoat,n.querySelector(".wizard-eyes").style.fill=e.colorEyes,n};const o=e.querySelector(".setup-similar-list");window.render=function(t){const l=t.length>4?4:t.length;o.innerHTML="";let r=document.createDocumentFragment();for(let e=0;e<l;e++)r.append(n(t[e]));o.append(r),e.querySelector(".setup-similar").classList.remove("hidden")}})(),(()=>{const e=document.querySelector(".setup"),t=document.querySelector(".setup-open"),n=e.querySelector(".setup-close"),o=e.querySelector(".setup-user-name");let l=getComputedStyle(e);const r=l.top,i=l.left;let a=function(e){window.util.isEscEvent(e,s,o)},c=function(){e.style.top=r,e.style.left=i,e.classList.remove("hidden"),document.addEventListener("keydown",a)},s=function(){e.classList.add("hidden"),document.removeEventListener("keydown",a)};t.addEventListener("click",(function(){c()})),t.addEventListener("keydown",(function(e){window.util.isEnterEvent(e,c())})),n.addEventListener("click",(function(){s()})),n.addEventListener("keydown",(function(e){window.util.isEnterEvent(e,s())}))})(),(()=>{const e=document.querySelector(".setup"),t=e.querySelector(".upload");t.addEventListener("mousedown",(function(n){n.preventDefault();let o={x:n.clientX,y:n.clientY},l=!1,r=function(t){t.preventDefault(),l=!0;let n=o.x-t.clientX,r=o.y-t.clientY;o={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-r+"px",e.style.left=e.offsetLeft-n+"px"},i=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i),l){let e=function(n){n.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};document.addEventListener("mousemove",r),document.addEventListener("mouseup",i)}))})(),(()=>{let e=function(e,t,n,o){e.fillStyle=o,e.fillRect(t,n,420,270)};window.renderStatistics=function(t,n,o){e(t,110,20,"rgba(0,0,0,0.7)"),e(t,100,10,"#ffffff"),t.fillStyle="#000000",t.font="16px  PT Mono",t.textBaseline="hanging",t.fillText("Ура, вы победили!",130,30),t.fillText("Список результатов:",130,50),t.save(),t.translate(0,270);let l=function(e){let t=e[0];for(let n=0;n<e.length;n++)e[n]>t&&(t=e[n]);return t}(o);for(let e=0;e<n.length;e++){if(t.fillText(n[e],150+90*e,-20),"Вы"===n[e])t.fillStyle="rgba(255, 0, 0, 1)";else{let e=`hsl(230, ${Math.round(100*Math.random())}%, 50%)`;t.fillStyle=e}t.fillRect(150+90*e,-30,40,-150*o[e]/l),t.fillStyle="#000000",t.fillText(Math.round(o[e]),150+90*e,-150*o[e]/l-20-10-20)}t.restore()}})()})();